#!/usr/bin/env ruby

PROJECT_DIR = File.expand_path('../..', __FILE__)
$LOAD_PATH.push(File.join(PROJECT_DIR, 'lib'))

require 'yaml'
require 'optparse'

Signal.trap("INT") { exit(0) }

def generators_summary
  generators = Generator.list_generators
  max_len = generators.map(&:length).max
  generators.map do |generator|
    descr = Generator.summary(generator)
    "#{generator} #{' ' * (max_len - generator.length)}- #{descr}"
  end
end

opts = {}
parser = OptionParser.new do |options|
  options.banner =<<-HERE
  Usage: ./#{File.basename($0)} [options] | entrospect
         ./#{File.basename($0)} [options] > <path-to-file> 

  Available Generators:
    - #{generators_summary.join("\n    - ")}

  Options:
  HERE

  options.on("-g", "--generator GENERATOR",
             "name of generator to use for streaming pseudo random data") do |g|
    opts[:generator] = g
  end

  options.on("-l", "--limit nnn",
             "stop generation after stream exceeds nnn bytes\n" +
             "\t\t\t\t    (CTRL-C to terminate)" ) do |l|
    unit = { 'k' => 1024, 'm' => 2**20, 'g' => 2**30 }[l[-1].downcase]
    opts[:limit] = l.to_i * (unit || 1)
  end

  options.on("-h", "--help", "Show this help") do
    puts options
    exit
  end

end

begin
  parser.parse!
rescue OptionParser::MissingArgument => e
  puts parser
  exit 1
end

unless opts[:generator]
  puts parser
  exit 1
end

Generator.run(opts)
